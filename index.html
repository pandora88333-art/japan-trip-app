<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Èõ™Âúã‰πãÊóÖ ‚ùÑÔ∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        window.fb = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, deleteDoc, writeBatch };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Rubik:wght@300;400;500;700&display=swap');
        body { font-family: 'Rubik', 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        /* Animations */
        .slide-in-right { animation: slideRight 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes slideRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .slide-up-sheet { animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        /* Visual Styles */
        .glass-card { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.6); }
        .bg-snow-theme { background-image: url('https://images.unsplash.com/photo-1530545124313-ce5e10642199?q=80&w=1974&auto=format&fit=crop'); background-size: cover; background-position: center; background-attachment: fixed; }
        .q-calendar-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), inset 0 -2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useRef } = React;

        // ==========================================
        // üî¥ Ë´ãÂú®Ê≠§Ë≤º‰∏ä Firebase Ë®≠ÂÆöÁ¢º (ÂøÖË¶Å!)
        // ==========================================
        const firebaseConfig = {
    apiKey: "AIzaSyCVjGUYcRpHMNwBqSGkodJocffDU-3lCkc",
    authDomain: "celebrate-leaving-the-job.firebaseapp.com",
    projectId: "celebrate-leaving-the-job",
    storageBucket: "celebrate-leaving-the-job.firebasestorage.app",
    messagingSenderId: "890978169786",
    appId: "1:890978169786:web:3a4a6a41c29da98c486383",
    measurementId: "G-41G89KYTBD"
  };

        const TRIP_ID = 'japan-winter-2025'; // ÂîØ‰∏ÄÁöÑÊóÖÁ®ã ID

        // --- ü§ñ AI È†êÂÖàÂàÜÊûêÁöÑÊôØÈªûÊîªÁï•Ë≥áÊñôÂ∫´ ---
        const AI_HINTS = {
            "ÁöáÂ±ÖÂ§ñËãë": "ÊîªÁï•Ôºö‰∫åÈáçÊ©ãÊòØÂøÖÊãçÊôØÈªû„ÄÇÂª∫Ë≠∞Âæû„ÄåÊ´ªÁî∞ÈñÄ„ÄçÈÄ≤ÂÖ•ÔºåË¶ñÈáéËºÉÁÇ∫ÈñãÈóä„ÄÇËã•ÈÅáÂà∞ÁöáÂ±ÖÊù±Âæ°ËãëÈñãÊîæÊó•Ôºå‰∏çÂ¶®ÈÄ≤ÂéªÂèÉËßÄÔºàÂÖçË≤ªÔºâ„ÄÇ",
            "Ê∑∫ËçâÂØ∫": "ÂÜ∑Áü•Ë≠òÔºöÈõ∑ÈñÄÁöÑÂ§ßÁáàÁ±†ÈáçÈÅî 700 ÂÖ¨Êñ§ÔºÅ‰ª≤Ë¶ã‰∏ñÈÄöÂøÖÂêÉÔºö‰∫∫ÂΩ¢Ááí„ÄÅÁÇ∏ËÇâÈ§Ö„ÄÇÊîªÁï•ÔºöÊÉ≥ÈÅøÈñã‰∫∫ÊΩÆÊãçÈõ∑ÈñÄÔºåÂª∫Ë≠∞Êó©‰∏ä 8 ÈªûÂâçÊàñÊôö‰∏ä 8 ÈªûÂæåÂâçÂæÄ„ÄÇ",
            "Êô¥Á©∫Â°î": "ÊîªÁï•ÔºöÈ†êÁ¥Ñ 15:30 ÊòØÁÇ∫‰∫ÜÂêåÊôÇÁúãÊó•ÊôØ„ÄÅÂ§ïÈôΩÂíåÁôæËê¨Â§úÊôØ„ÄÇÂà•Âøò‰∫ÜÂéª 4 Ê®ìÊà∂Â§ñÈú≤Âè∞ÊãçÊô¥Á©∫Â°îÂÖ®Ë≤å„ÄÇ",
            "ÁßãËëâÂéüÂãïÊº´Â∑°Á¶Æ": "ÊîªÁï•ÔºöRadio ÊúÉÈ§®ÊòØÁ∂úÂêàÂûãÂ§ßÊ®ìÔºåÈÅ©Âêà‰∏ÄÊ¨°Ë≤∑ÈΩä„ÄÇÊÉ≥ÊâæÁ®ÄÊúâÂìÅË¶ÅÂéªÂ∑∑ÂºÑË£°ÁöÑÂ∞èÂ∫ó„ÄÇÈÄ±Êó•‰∏≠Â§ÆÈÄöÊúÉÂ∞ÅË°óËÆäÊàêÊ≠•Ë°åËÄÖÂ§©Âúã„ÄÇ",
            "ÂéüÂÆøÁ´π‰∏ãÈÄö": "ÊîªÁï•ÔºöÈÄôË£°‰∫∫ÊΩÆÊ¥∂ÊπßÔºåÁü•ÂêçÂèØÈ∫óÈ§ÖÂ∫óÈÄöÂ∏∏Â§ßÊéíÈï∑Èæç„ÄÇÂª∫Ë≠∞Âπ≥Êó•‰∏äÂçàÂâçÂæÄ„ÄÇÈôÑËøëÂ∑∑ÂºÑË£°ÁöÑ„ÄåË£°ÂéüÂÆø„ÄçÊúâÊõ¥Â§öÂÄãÊÄßÊΩÆÁâå„ÄÇ",
            "ÊæÄË∞∑ SKY": "ÂøÖËÆÄÔºöÈñÄÁ•®ÈùûÂ∏∏Êê∂ÊâãÔºå‰∏ÄÂÆöË¶ÅÊèêÂâç‰∏ÄÂÄãÊúàË®ÇÔºÅÈÄôÂÄãÊôÇÊÆµÂéªÂâõÂ•ΩÂèØ‰ª•ÁúãÊó•ËêΩ„ÄÇÊ≥®ÊÑèÈ†ÇÊ®ìÈ¢®Â§ßÔºå‰∏îÁ¶ÅÊ≠¢ÊîúÂ∏∂ËÖ≥Êû∂„ÄÅËá™ÊãçÊ£íÂíåÂ∏ΩÂ≠ê„ÄÇ",
            "ËóèÁéãÊ®πÂÜ∞": "Ê•µÈáçË¶ÅÊîªÁï•ÔºöÂ±±È†ÇÊ∫´Â∫¶Ê•µ‰ΩéÔºà-10Â∫¶‰ª•‰∏ãÔºâÔºåÂãôÂøÖ„ÄåÂÖ®ÂâØÊ≠¶Ë£ù„ÄçÔºöÈò≤Ê∞¥Èõ™Èù¥„ÄÅÂéöÊâãÂ•ó„ÄÅÊØõÂ∏Ω„ÄÅÈò≤È¢®Â§ñÂ•ó„ÄÇÊâãÊ©üÂÆπÊòìÂáçÂà∞ÈóúÊ©üÔºåÂª∫Ë≠∞Ë≤ºÊöñÊöñÂåÖ„ÄÇ",
            "ËóèÁéãÊ∫´Ê≥â": "ÁâπËâ≤ÔºöÂº∑ÈÖ∏ÊÄßÁöÑÁ°´Á£∫Ê≥âÔºåÂ∞çÁöÆËÜöÁóÖÊúâÁôÇÊïàÔºå‰ΩÜÈäÄÈ£æÂìÅÊúÉËÆäÈªëÔºåÂÖ•Êµ¥ÂâçË´ãÊëò‰∏ã„ÄÇ",
            "ÈäÄÂ±±Ê∫´Ê≥â": "ÊîªÁï•ÔºöÂÇçÊôöËóçË™øÊôÇÂàªÔºàBlue HourÔºâÊòØÊãçÁÖßÈªÉÈáëÊôÇÈñìÔºåÁì¶ÊñØÁáà‰∫ÆËµ∑Êê≠ÈÖçÈõ™ÊôØÂ¶ÇÂ§¢‰ººÂπª„ÄÇ‰∫∫Ë°åÈÅìÂèØËÉΩÁµêÂÜ∞ÊøïÊªëÔºåËµ∞Ë∑ØË´ãÂ∞èÊ≠•ÊÖ¢Ë°å„ÄÇ",
            "ËóèÁéãÁãêÁã∏Êùë": "ÂÆâÂÖ®È†àÁü•ÔºöÂçÉËê¨‰∏çË¶ÅËπ≤‰∏ãÊàñÂòóË©¶Ëß∏Êë∏ÁãêÁã∏ÔºåÁâ†ÂÄëÊúÉ‰ª•ÁÇ∫‰Ω†Ë¶ÅÈ§µÈ£üËÄåÂí¨‰∫∫„ÄÇÂè™ËÉΩÂú®ÊåáÂÆöÂçÄÂüüÊä±ÁãêÁã∏ÊãçÁÖß„ÄÇÈö®Ë∫´Áâ©ÂìÅË¶ÅÊî∂Â•ΩÔºåÁãêÁã∏ÂæàÊÑõÂí¨Â°ëËÜ†Ë¢ã„ÄÇ",
            "ÁëûÈ≥≥ÊÆø": "ËÉåÊôØÔºö‰ºäÈÅîÊîøÂÆóÁöÑÈùàÂªüÔºåÂª∫ÁØâÈ¢®Ê†ºËèØÈ∫óÔºåÁ®±ÁÇ∫„ÄåÊ°ÉÂ±±ÊñáÂåñ„Äç„ÄÇÊà∞ÂæåÈáçÂª∫ÔºåËâ≤ÂΩ©ÈÆÆË±îÔºåÂú®Èõ™ÊôØ‰∏≠ÈùûÂ∏∏ÈÜíÁõÆ„ÄÇ"
        };

        // --- ÂàùÂßãË°åÁ®ãË≥áÊñô (Âê´Â§©Ê∞£È†êÂ†±) ---
        // Ê≥®ÊÑèÔºöÈÄôË£°È†êÂ°´‰∫ÜÂ§©Ê∞£Ë≥áË®äÔºåÂØ¶ÈöõÊáâÁî®ÈúÄÊé•Â§©Ê∞£ APIÔºå‰ΩÜÁÇ∫Á∞°ÂåñÊ≠§ËôïÊâãÂãïÂ°´ÂØ´
        const INITIAL_ITINERARY = [
            { id: 'd1', day: 1, date: "12/15", weekday: "Êó•", title: "Êù±‰∫¨ÊäµÈÅî", weather: "cloudy", temp: "8¬∞C", rain: "20%", cloth: "ÁôºÁÜ±Ë°£+ÊØõË°£+Èò≤È¢®Â§ñÂ•ó", activities: [
                { id: 'a1', time: "16:25", title: "È£õÂæÄÊù±‰∫¨", detail: "CI0106 TPE -> NRT (T2)", notes: "" },
                { id: 'a2', time: "21:00", title: "SKYLINER ÈÄ≤Â∏ÇÂçÄ", detail: "ÊàêÁî∞T2 -> ‰∫¨Êàê‰∏äÈáé (¬•2570)", notes: "" },
                { id: 'a3', time: "22:30", title: "È£ØÂ∫ó Check-in", detail: "MYSTAYS Âæ°Ëå∂‰πãÊ∞¥", notes: "Ë®òÂæóÂá∫Á§∫Ë≠∑ÁÖß" }
            ]},
            { id: 'd2', day: 2, date: "12/16", weekday: "‰∏Ä", title: "Á∂ìÂÖ∏Êù±‰∫¨", weather: "sunny", temp: "10¬∞C", rain: "0%", cloth: "Ê¥ãËî•ÂºèÁ©øÊê≠ÔºåÂ•ΩËµ∞ÁöÑÈûã", activities: [
                { id: 'b1', time: "09:00", title: "ÁöáÂ±ÖÂ§ñËãë", detail: "‰∫åÈáçÊ©ãÊï£Ê≠•", notes: "" },
                { id: 'b2', time: "13:00", title: "Ê∑∫ËçâÂØ∫", detail: "Èõ∑ÈñÄ & ‰ª≤Ë¶ã‰∏ñÈÄö", notes: "" },
                { id: 'b3', time: "15:30", title: "Êô¥Á©∫Â°î", detail: "È†êÁ¥Ñ 15:30 ÁúãÂ§ïÈôΩ", notes: "" },
                { id: 'b4', time: "18:30", title: "ÁßãËëâÂéüÂãïÊº´Â∑°Á¶Æ", detail: "ÊôöÈ§êÂú®Ê≠§Ëß£Ê±∫", notes: "" }
            ]},
            { id: 'd3', day: 3, date: "12/17", weekday: "‰∫å", title: "ÊΩÆÊµÅËÅñÂú∞", weather: "sunny", temp: "12¬∞C", rain: "10%", cloth: "Ëºï‰æø‰øùÊöñÔºåÈÅ©ÂêàÈÄõË°ó", activities: [
                { id: 'c1', time: "10:00", title: "ÂéüÂÆøÁ´π‰∏ãÈÄö", detail: "ÈÄõË°óÂêÉÂèØÈ∫óÈ§Ö", notes: "" },
                { id: 'c2', time: "14:20", title: "ÊæÄË∞∑ SKY", detail: "È†êÁ¥Ñ 14:20ÔºåÁ¶ÅÊ≠¢Â∏∂ËÖ≥Êû∂", notes: "" },
                { id: 'c3', time: "17:00", title: "Ê±†Ë¢ãÂãïÊº´ËÅñÂú∞", detail: "Animate Á∏ΩÂ∫ó", notes: "" }
            ]},
            { id: 'd4', day: 4, date: "12/18", weekday: "‰∏â", title: "ÂâçÂæÄÈõ™Âúã", weather: "snow", temp: "-2¬∞C", rain: "80%Èõ™", cloth: "ÈÄ≤ÂÖ•Èõ™ÂúãÔºÅÈò≤Ê∞¥Èõ™Èù¥„ÄÅÊâãÂ•óÊØõÂ∏ΩÂøÖÂÇô", activities: [
                { id: 'd1', time: "12:00", title: "Â±±ÂΩ¢Êñ∞ÂππÁ∑ö", detail: "Êù±‰∫¨ -> Â±±ÂΩ¢ (Á¥Ñ2.5hr)", notes: "Ëªä‰∏äÂêÉ‰æøÁï∂" },
                { id: 'd2', time: "15:00", title: "Â∑¥Â£´‰∏äÂ±±", detail: "Â±±ÂΩ¢Á´ô -> ËóèÁéãÊ∫´Ê≥â", notes: "Ê∫ñÂÇôÈõ∂Èå¢¬•1000" },
                { id: 'd3', time: "16:00", title: "ÂÖ•‰ΩèÈ£ØÂ∫ó", detail: "È´òÂÆÆÁêâÁíÉÊ∏°ÂÅáÈÖíÂ∫ó", notes: "‰∫´ÂèóÊ∫´Ê≥â" }
            ]},
            { id: 'd5', day: 5, date: "12/19", weekday: "Âõõ", title: "ËóèÁéãÊªëÈõ™", weather: "snow", temp: "-5¬∞C", rain: "90%Èõ™", cloth: "ÂÖ®Â•óÂ∞àÊ•≠ÊªëÈõ™Ë£ùÂÇô", activities: [
                { id: 'e1', time: "10:00", title: "ÁßüÂÄüË£ùÂÇô", detail: "È£ØÂ∫óÊàñÈôÑËøëÈõ™ÂÖ∑Â∫ó", notes: "" },
                { id: 'e2', time: "11:00", title: "ÊªëÈõ™Ë™≤Á®ã", detail: "11:00 - 17:00", notes: "Ê≥®ÊÑèÂÆâÂÖ®ÔºåÈáèÂäõËÄåÁÇ∫" }
            ]},
            { id: 'd6', day: 6, date: "12/20", weekday: "‰∫î", title: "Ê®πÂÜ∞Ëàá‰ªôÂè∞", weather: "cloudy", temp: "2¬∞C", rain: "30%", cloth: "Â±±‰∏äÊ•µÂÜ∑ÈúÄÈáçË£ùÔºå‰∏ãÂ±±Âæå‰∏ÄËà¨ÂÜ¨Ë£ù", activities: [
                { id: 'f1', time: "09:00", title: "ËóèÁéãÊ®πÂÜ∞", detail: "Êê≠‰πòÁ∫úËªäËá≥Â±±È†Ç", notes: "Â±±È†ÇÈùûÂ∏∏ÂÜ∑ÔºåÊ≥®ÊÑè‰øùÊöñ" },
                { id: 'f2', time: "14:30", title: "ÂâçÂæÄ‰ªôÂè∞", detail: "Â∑¥Â£´‰∏ãÂ±±ËΩâ JR ‰ªôÂ±±Á∑ö", notes: "" },
                { id: 'f3', time: "18:00", title: "ÂÖ•‰Ωè‰ªôÂè∞", detail: "‰ªôÂè∞ËíôÁâπÂà©ÈÖíÂ∫ó", notes: "" }
            ]},
            { id: 'd7', day: 7, date: "12/21", weekday: "ÂÖ≠", title: "ÁôÇÁôí‰πãÊóÖ", weather: "snow", temp: "0¬∞C", rain: "60%Èõ™", cloth: "Êà∂Â§ñË°åÁ®ãÂ§öÔºåÈûãÂ≠êÈúÄÈò≤Êªë", activities: [
                { id: 'g1', time: "08:30", title: "Â•óË£ùË°åÁ®ãÂá∫Áôº", detail: "ÂâçÂæÄÁãêÁã∏Êùë", notes: "Ê∫ñÊôÇÈõÜÂêà" },
                { id: 'g2', time: "10:00", title: "ËóèÁéãÁãêÁã∏Êùë", detail: "Êä±ÁãêÁã∏È´îÈ©ó", notes: "ÂãøÈö®ÊÑèËß∏Êë∏" },
                { id: 'g3', time: "14:00", title: "ÈäÄÂ±±Ê∫´Ê≥â", detail: "Â§ßÊ≠£Êµ™Êº´Ë°óÊôØ", notes: "ÂÇçÊôöÊãçÁÖßÊúÄÁæé" }
            ]},
            { id: 'd8', day: 8, date: "12/22", weekday: "Êó•", title: "‰ªôÂè∞ËøîÁ®ã", weather: "cloudy", temp: "8¬∞C", rain: "20%", cloth: "ËàíÈÅ©Â∏ÇÂçÄËßÄÂÖâË£ùÊâÆ", activities: [
                { id: 'h1', time: "09:00", title: "ÁëûÈ≥≥ÊÆø & ÂüéË∑°", detail: "‰ºäÈÅîÊîøÂÆóÊ≠∑Âè≤Â∑°Á¶Æ", notes: "" },
                { id: 'h2', time: "15:00", title: "Êñ∞ÂππÁ∑öÂõû‰∏äÈáé", detail: "ÈöºËôü Hayabusa", notes: "" },
                { id: 'h3', time: "19:00", title: "ÂÖ•‰ΩèÊàêÁî∞", detail: "MYSTAYS ÊàêÁî∞Á≤æÂìÅ", notes: "" }
            ]},
            { id: 'd9', day: 9, date: "12/23", weekday: "‰∏Ä", title: "ËøîÂõûÂè∞ÁÅ£", weather: "sunny", temp: "15¬∞C", rain: "0%", cloth: "Ëºï‰æøÁÇ∫‰∏ªÔºåÊñπ‰æøÊê≠Ê©ü", activities: [
                { id: 'i1', time: "09:00", title: "ÊàêÁî∞Â±±Êñ∞ÂãùÂØ∫", detail: "Ê©üÂ†¥ÈôÑËøëÂçäÊó•ÈÅä", notes: "ÂèØÈÅ∏Ë°åÁ®ã" },
                { id: 'i2', time: "14:30", title: "Ê©üÂ†¥Â†±Âà∞", detail: "ÊàêÁî∞ T2", notes: "" },
                { id: 'i3', time: "17:30", title: "È£õÂæÄÂè∞Âåó", detail: "CI0109", notes: "Âπ≥ÂÆâÂõûÂÆ∂" }
            ]}
        ];

        // --- Icons (Lucide) ---
        const Icons = {
            Grid: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            Wallet: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>,
            Heart: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
            Plane: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5 3.4 2.6-3.7 3.7-3.4-1.3-.5.3v.5l3.7 3.2 1.6 3.6.5.3.5-1.3 1.3 3.4 3.7-3.7 2.6 3.4.5-.3.5-1.1c.4-.2.6-.6.5-1.1z"/></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            MapPin: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            Edit3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            CloudRain: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></svg>,
            Snowflake: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/><path d="m20 16-4-4 4-4"/><path d="m4 8 4 4-4 4"/><path d="m16 4-4 4-4-4"/><path d="m8 20 4-4 4 4"/></svg>,
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            CheckSquare: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 11 3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
            Square: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>,
        };
        const Icon = ({ name, className }) => { const C = Icons[name]; return <div className={className}>{C ? <C /> : null}</div>; };

        // --- Hook: Firebase Ë≥áÊñôÂêåÊ≠• ---
        const useTripData = () => {
            const [itinerary, setItinerary] = useState(INITIAL_ITINERARY);
            const [expenses, setExpenses] = useState([]);
            const [wishlist, setWishlist] = useState([]);
            const [user, setUser] = useState(null);
            const dbRef = useRef(null);

            useEffect(() => {
                if (!firebaseConfig.apiKey) { console.warn("Firebase config missing"); return; }
                const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, onSnapshot, setDoc, collection, writeBatch } = window.fb;
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                dbRef.current = getFirestore(app);
                signInAnonymously(auth);
                onAuthStateChanged(auth, u => {
                    if (u) {
                        setUser(u);
                        const itineraryRef = doc(dbRef.current, 'trips', TRIP_ID, 'data', 'itinerary');
                        onSnapshot(itineraryRef, s => {
                            if (s.exists()) setItinerary(s.data().data);
                            else setDoc(itineraryRef, { data: INITIAL_ITINERARY });
                        });
                        onSnapshot(collection(dbRef.current, 'trips', TRIP_ID, 'expenses'), s => {
                            setExpenses(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => b.createdAt - a.createdAt));
                        });
                        onSnapshot(collection(dbRef.current, 'trips', TRIP_ID, 'wishlist'), s => {
                            setWishlist(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => b.createdAt - a.createdAt));
                        });
                    }
                });
            }, []);

            const actions = useMemo(() => ({
                updateDayActivities: async (dayId, newActivities) => {
                    if (!user || !dbRef.current) return;
                    const newItinerary = itinerary.map(d => d.id === dayId ? { ...d, activities: newActivities } : d);
                    await window.fb.updateDoc(window.fb.doc(dbRef.current, 'trips', TRIP_ID, 'data', 'itinerary'), { data: newItinerary });
                },
                addExpense: async (exp) => {
                    if (!user || !dbRef.current) return;
                    await window.fb.setDoc(window.fb.doc(window.fb.collection(dbRef.current, 'trips', TRIP_ID, 'expenses')), { ...exp, createdAt: Date.now() });
                },
                deleteExpense: async (id) => await window.fb.deleteDoc(window.fb.doc(dbRef.current, 'trips', TRIP_ID, 'expenses', id)),
                addWish: async (text) => {
                     if (!user || !dbRef.current) return;
                    await window.fb.setDoc(window.fb.doc(window.fb.collection(dbRef.current, 'trips', TRIP_ID, 'wishlist')), { text, checked: false, createdAt: Date.now() });
                },
                toggleWish: async (id, checked) => await window.fb.updateDoc(window.fb.doc(dbRef.current, 'trips', TRIP_ID, 'wishlist', id), { checked }),
                deleteWish: async (id) => await window.fb.deleteDoc(window.fb.doc(dbRef.current, 'trips', TRIP_ID, 'wishlist', id)),
            }), [user, itinerary]);

            return { itinerary, expenses, wishlist, user, actions };
        };

        // --- Components ---

        // Â∫ïÈÉ®Â∞éËà™Âàó
        const BottomNav = ({ activeTab, onTabChange }) => (
            <div className="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-blue-100/50 px-6 py-3 flex justify-around z-40 pb-safe shadow-[0_-4px_10px_rgba(0,0,0,0.05)]">
                {[
                    { id: 'dashboard', icon: 'Grid', label: 'Á∏ΩË¶Ω' },
                    { id: 'itinerary', icon: 'List', label: 'Ë°åÁ®ã' },
                    { id: 'expenses', icon: 'Wallet', label: 'ÂàÜÂ∏≥' },
                    { id: 'wishlist', icon: 'Heart', label: 'È°òÊúõ' },
                ].map(tab => (
                    <button key={tab.id} onClick={() => onTabChange(tab.id)} className={`flex flex-col items-center gap-1 transition-all ${activeTab === tab.id ? 'text-blue-600 scale-105' : 'text-slate-400'}`}>
                        <Icon name={tab.icon} className={`w-6 h-6 ${activeTab === tab.id ? 'stroke-[2.5px]' : 'stroke-2'}`} />
                        <span className="text-[10px] font-medium">{tab.label}</span>
                    </button>
                ))}
            </div>
        );

        // Á∏ΩË¶ΩÈ†ÅÈù¢
        const DashboardView = ({ itinerary }) => {
            const today = new Date();
            today.setHours(0,0,0,0);
            const tripStartDate = new Date('2025-12-15T00:00:00');
            const diffTime = tripStartDate - today;
            const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let currentDayData = itinerary[0];
            let dayProgressText = "";

            if (daysUntil > 0) {
                dayProgressText = `ÈÇÑÊúâ ${daysUntil} Â§©Âá∫Áôº`;
            } else {
                const currentDayIndex = Math.min(Math.abs(daysUntil), itinerary.length - 1);
                currentDayData = itinerary[currentDayIndex];
                dayProgressText = daysUntil === 0 ? "Â∞±ÊòØ‰ªäÂ§©ÔºÅ" : `ÊóÖÁ®ãÁ¨¨ ${Math.abs(daysUntil) + 1} Â§©`;
            }
            
            const WeatherIcon = currentDayData.weather === 'snow' ? 'Snowflake' : currentDayData.weather === 'rain' ? 'CloudRain' : 'Sun';
            const weatherColor = currentDayData.weather === 'snow' ? 'text-blue-300' : currentDayData.weather === 'rain' ? 'text-blue-400' : 'text-yellow-400';

            return (
                <div className="p-4 space-y-4 pt-16">
                    {/* Header */}
                     <div className="flex items-center justify-between mb-2 px-1">
                        <div>
                            <h1 className="text-2xl font-bold text-slate-800 tracking-tight flex items-center gap-2">
                                Japan Trip <Icon name="Plane" className="w-5 h-5 text-blue-500 rotate-[-45deg]"/>
                            </h1>
                            <p className="text-xs text-slate-500 tracking-wider">{today.toLocaleDateString()}</p>
                        </div>
                    </div>

                    {/* Status Card */}
                    <div className="glass-card rounded-3xl p-6 text-slate-700 relative overflow-hidden">
                        <div className="absolute -right-8 -top-8 text-blue-100/30"><Icon name="Snowflake" className="w-32 h-32" /></div>
                        <p className="text-xs font-bold text-blue-500 tracking-wider mb-1">TRIP STATUS</p>
                        <h2 className="text-3xl font-bold text-blue-800 mb-4">{dayProgressText}</h2>
                         <div className="flex items-center gap-2 text-sm text-slate-600 bg-white/50 p-2 rounded-xl w-fit backdrop-blur-sm">
                            <Icon name="MapPin" className="w-4 h-4 text-blue-500" />
                            ‰∏ã‰∏ÄÁ´ôÔºö{currentDayData.title}
                        </div>
                    </div>

                     {/* Weather Widget */}
                    <div className="glass-card rounded-3xl p-5 flex items-stretch">
                        <div className="flex-1 pr-4 border-r border-blue-100/50">
                            <p className="text-xs font-bold text-slate-400 mb-1">‰ªäÊó•Â§©Ê∞£ ({currentDayData.day > 9 ? 'N/A' : currentDayData.date})</p>
                            <div className="flex items-center gap-3">
                                <Icon name={WeatherIcon} className={`w-10 h-10 ${weatherColor}`} />
                                <div>
                                    <p className="text-2xl font-bold text-slate-800">{currentDayData.temp}</p>
                                    <p className="text-xs text-slate-500">ÈôçÈõ®Ê©üÁéá: {currentDayData.rain}</p>
                                </div>
                            </div>
                        </div>
                         <div className="flex-1 pl-4 flex flex-col justify-center">
                             <p className="text-xs font-bold text-slate-400 mb-1">Âª∫Ë≠∞Á©øËëó</p>
                             <p className="text-sm text-slate-700 leading-relaxed">{currentDayData.cloth}</p>
                        </div>
                    </div>
                </div>
            );
        };

        // Ë°åÁ®ãÁ∏ΩË¶Ω (QÁâàÊúàÊõÜ)
        const CalendarGridView = ({ itinerary, onSelectDay }) => (
            <div className="p-4 pt-16">
                 <h2 className="text-xl font-bold text-slate-800 mb-4 px-1 flex items-center gap-2">Ë°åÁ®ã‰∏ÄË¶Ω <Icon name="Sparkles" className="w-5 h-5 text-yellow-400"/></h2>
                <div className="grid grid-cols-2 gap-4 pb-24">
                    {itinerary.map((day) => (
                        <div key={day.id} onClick={() => onSelectDay(day)} className="aspect-square glass-card rounded-3xl p-3 flex flex-col justify-between cursor-pointer transition-transform active:scale-95 relative overflow-hidden q-calendar-shadow group hover:border-blue-300/50">
                            <div className="flex justify-between items-start z-10">
                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${['ÂÖ≠','Êó•'].includes(day.weekday) ? 'bg-red-100 text-red-500' : 'bg-slate-200 text-slate-500'}`}>{day.weekday}</span>
                                {day.weather === 'snow' && <Icon name="Snowflake" className="w-4 h-4 text-blue-300" />}
                            </div>
                            <div className="absolute inset-0 flex items-center justify-center z-0 pt-4">
                                <span className="text-5xl font-bold text-slate-800/80 font-mono tracking-tighter group-hover:text-blue-600/80 transition-colors">{day.date.split('/')[1]}</span>
                            </div>
                            <div className="z-10 text-center bg-white/60 backdrop-blur-sm py-1 rounded-xl">
                                <span className="text-xs font-bold text-slate-700 line-clamp-1">{day.title}</span>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        // ÂñÆÊó•Ë°åÁ®ãÂàóË°® (ÊªëÂÖ•Ë¶ñÁ™ó)
        const DayDetailView = ({ day, onBack, onSelectActivity }) => (
            <div className="fixed inset-0 bg-snow-theme z-30 slide-in-right flex flex-col">
                 <div className="absolute inset-0 bg-blue-50/60 backdrop-blur-[2px]"></div>
                 <div className="relative z-10 flex-1 flex flex-col h-full">
                    <div className="pt-12 px-4 pb-4 flex items-center gap-3 bg-white/60 backdrop-blur-md border-b border-white/50">
                        <button onClick={onBack} className="p-2 glass-card rounded-full active:bg-slate-100"><Icon name="ChevronLeft" className="w-6 h-6 text-slate-600" /></button>
                        <div>
                            <h2 className="text-xl font-bold text-slate-800">Day {day.day} - {day.title}</h2>
                            <p className="text-xs text-slate-500">{day.date} ({day.weekday})</p>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-24 no-scrollbar">
                        {day.activities.map((act, idx) => (
                            <div key={act.id} onClick={() => onSelectActivity(act)} className="glass-card p-5 rounded-2xl flex items-center justify-between active:bg-white/90 transition-all relative overflow-hidden group">
                                <div className="absolute left-0 top-0 bottom-0 w-1 bg-blue-200 group-hover:bg-blue-400 transition-colors"></div>
                                <div className="flex items-center gap-4 ml-2">
                                    <span className="font-mono font-bold text-blue-600 text-sm w-12">{act.time}</span>
                                    <span className="font-bold text-slate-700 text-lg line-clamp-1">{act.title}</span>
                                </div>
                                <div className="bg-slate-100/50 p-1 rounded-full"><div className="rotate-180"><Icon name="ChevronLeft" className="w-4 h-4 text-slate-400" /></div></div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        // Ë°åÁ®ãË©≥Á¥∞ & Á∑®ËºØ (Â∫ïÈÉ®ÂΩàÂá∫)
        const ActivityBottomSheet = ({ activity, isOpen, onClose, onSave, onDelete }) => {
            if (!isOpen || !activity) return null;
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState(activity);
            const aiHint = AI_HINTS[activity.title] || null; // Ëá™ÂãïÊêúÂ∞ãÊîªÁï•

            useEffect(() => { setEditData(activity); setIsEditing(false); }, [activity]);

            const handleSave = () => { onSave(editData); setIsEditing(false); };
            const openGoogleMap = () => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(activity.title + " " + activity.detail)}`, '_blank');

            return (
                <div className="fixed inset-0 z-50 flex items-end justify-center">
                    <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onClick={onClose} />
                    <div className="bg-white/95 backdrop-blur-xl w-full max-w-md rounded-t-[2rem] p-6 shadow-2xl relative slide-up-sheet max-h-[85vh] overflow-y-auto no-scrollbar">
                        <div className="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6" />
                        <div className="flex justify-between items-start mb-6">
                             {!isEditing ? (
                                <div className="flex gap-3 items-center">
                                     <div className="bg-blue-100 p-3 rounded-2xl text-blue-600"><Icon name="MapPin" className="w-6 h-6" /></div>
                                    <div><h3 className="text-2xl font-bold text-slate-800 leading-tight">{activity.title}</h3><span className="text-blue-600 font-mono font-bold">{activity.time}</span></div>
                                </div>
                             ) : (<p className="text-lg font-bold text-slate-700">Á∑®ËºØË°åÁ®ã</p>)}
                            <button onClick={() => setIsEditing(!isEditing)} className="p-2 bg-slate-100 rounded-full text-slate-500 active:bg-slate-200"><Icon name={isEditing ? "X" : "Edit3"} className="w-5 h-5" /></button>
                        </div>

                        {isEditing ? (
                            <div className="space-y-4">
                                <div className="flex gap-3">
                                    <div className="w-1/3"><label className="text-[10px] font-bold text-slate-400">ÊôÇÈñì</label><input className="w-full bg-slate-100 rounded-xl px-3 py-3 font-mono font-bold text-slate-700 focus:outline-blue-500" value={editData.time} onChange={e => setEditData({...editData, time: e.target.value})} /></div>
                                    <div className="flex-1"><label className="text-[10px] font-bold text-slate-400">Ê®ôÈ°å</label><input className="w-full bg-slate-100 rounded-xl px-3 py-3 font-bold text-slate-700 focus:outline-blue-500" value={editData.title} onChange={e => setEditData({...editData, title: e.target.value})} /></div>
                                </div>
                                <div><label className="text-[10px] font-bold text-slate-400">ÂÖßÂÆπ</label><textarea className="w-full bg-slate-100 rounded-xl px-3 py-3 text-sm text-slate-600 resize-none h-24 focus:outline-blue-500" value={editData.detail} onChange={e => setEditData({...editData, detail: e.target.value})} /></div>
                                <div><label className="text-[10px] font-bold text-slate-400">ÂÇôË®ª</label><input className="w-full bg-blue-50 border border-blue-100 rounded-xl px-3 py-3 text-sm text-slate-600 focus:outline-blue-500" value={editData.notes} onChange={e => setEditData({...editData, notes: e.target.value})} placeholder="ÂÇôË®ª..." /></div>
                                <div className="flex gap-3 pt-4">
                                    <button onClick={() => onDelete(activity.id)} className="flex-1 py-3 rounded-xl bg-red-50 text-red-400 font-bold text-sm flex justify-center items-center gap-2 active:scale-95 transition-transform"><Icon name="Trash2" className="w-4 h-4" /> Âà™Èô§</button>
                                    <button onClick={handleSave} className="flex-[2] py-3 rounded-xl bg-blue-600 text-white font-bold text-sm flex justify-center items-center gap-2 shadow-blue-200 shadow-lg active:scale-95 transition-transform"><Icon name="Save" className="w-4 h-4" /> ÂÑ≤Â≠ò</button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                <div><p className="text-sm font-bold text-slate-400 mb-2 tracking-wider">Ë©≥Á¥∞ÂÖßÂÆπ</p><p className="text-slate-700 text-lg leading-relaxed whitespace-pre-line">{activity.detail || "ÁÑ°Ë©≥Á¥∞ÂÖßÂÆπ"}</p></div>
                                <button onClick={openGoogleMap} className="w-full flex items-center justify-center gap-2 py-3 bg-green-50 text-green-700 rounded-xl font-bold text-sm hover:bg-green-100 transition active:scale-95"><Icon name="MapPin" className="w-4 h-4" /> ÈñãÂïü Google Maps</button>
                                {aiHint && (<div className="bg-yellow-50 p-4 rounded-xl border border-yellow-200/50 relative overflow-hidden"><div className="absolute -right-2 -top-2 text-yellow-200/50"><Icon name="Sparkles" className="w-16 h-16"/></div><p className="text-[10px] font-bold text-yellow-600 mb-1 flex items-center gap-1 relative z-10"><Icon name="Sparkles" className="w-3 h-3"/>Â∞èÂπ´ÊâãÊîªÁï•</p><p className="text-slate-700 text-sm leading-relaxed relative z-10">{aiHint}</p></div>)}
                                {activity.notes && (<div className="bg-slate-50 p-4 rounded-xl border border-slate-100"><p className="text-[10px] font-bold text-slate-400 mb-1">ÂÇôË®ª</p><p className="text-slate-600 text-sm">{activity.notes}</p></div>)}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ÂàÜÂ∏≥ & È°òÊúõÊ∏ÖÂñÆÂÖ±Áî®ÁµÑ‰ª∂
        const SharedListView = ({ title, icon, items, onItemAdd, onItemDelete, type }) => {
            const [input, setInput] = useState({ text: '', amount: '', currency: 'JPY', payer: 'Â∞èP' });
            const handleAdd = () => {
                if (type === 'expenses') {
                    if (!input.text || !input.amount) return;
                    onItemAdd({ ...input, amount: Number(input.amount) });
                    setInput({ text: '', amount: '', currency: 'JPY', payer: 'Â∞èP' });
                } else {
                    if (!input.text) return;
                    onItemAdd(input.text);
                    setInput({ ...input, text: '' });
                }
            };

            const summary = useMemo(() => {
                if (type !== 'expenses') return null;
                let s = { 'Â∞èP': { JPY: 0, TWD: 0 }, 'ÁôæÊ∂µ': { JPY: 0, TWD: 0 } };
                items.forEach(i => s[i.payer][i.currency] += i.amount);
                const totalJPY = s['Â∞èP'].JPY + s['ÁôæÊ∂µ'].JPY;
                const totalTWD = s['Â∞èP'].TWD + s['ÁôæÊ∂µ'].TWD;
                const oweJPY = (totalJPY / 2) - s['Â∞èP'].JPY;
                const oweTWD = (totalTWD / 2) - s['Â∞èP'].TWD;
                return { totalJPY, totalTWD, oweJPY, oweTWD };
            }, [items, type]);

            return (
                <div className="p-4 pt-16 space-y-4 pb-24">
                    <h2 className="text-xl font-bold text-slate-800 px-1 flex items-center gap-2">{title} <Icon name={icon} className={`w-6 h-6 ${type==='expenses'?'text-blue-500':'text-pink-500'}`}/></h2>
                    
                    {summary && (
                        <div className="glass-card rounded-3xl p-5 bg-gradient-to-br from-blue-500/10 to-purple-500/5">
                            <h3 className="text-xs font-bold text-blue-600 mb-3">ÁµêÁÆóÊëòË¶Å (È†êË®≠Âπ≥ÂàÜ)</h3>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div className="bg-white/60 p-3 rounded-2xl"><p className="text-xs text-slate-400">Á∏ΩÊó•Âπ£</p><p className="text-xl font-bold text-blue-600">¬•{summary.totalJPY.toLocaleString()}</p></div>
                                <div className="bg-white/60 p-3 rounded-2xl"><p className="text-xs text-slate-400">Á∏ΩÂè∞Âπ£</p><p className="text-xl font-bold text-green-600">NT${summary.totalTWD.toLocaleString()}</p></div>
                            </div>
                            {summary.oweJPY === 0 && summary.oweTWD === 0 ? <p className="text-sm text-center font-bold text-slate-600 bg-white/60 py-2 rounded-xl">ÁõÆÂâçÂÖ©Ê∏ÖÔºÅ</p> : (
                                <div className="space-y-2 bg-white/60 p-3 rounded-2xl">
                                    {Math.abs(summary.oweJPY) > 0 && <p className="text-sm flex justify-between font-bold"><span>üáØüáµ {summary.oweJPY > 0 ? "Â∞èPÊ¨†ÁôæÊ∂µ" : "ÁôæÊ∂µÊ¨†Â∞èP"}</span><span className="text-blue-600">¬•{Math.abs(summary.oweJPY).toLocaleString()}</span></p>}
                                    {Math.abs(summary.oweTWD) > 0 && <p className="text-sm flex justify-between font-bold"><span>üáπüáº {summary.oweTWD > 0 ? "Â∞èPÊ¨†ÁôæÊ∂µ" : "ÁôæÊ∂µÊ¨†Â∞èP"}</span><span className="text-green-600">${Math.abs(summary.oweTWD).toLocaleString()}</span></p>}
                                </div>
                            )}
                        </div>
                    )}

                    <div className="glass-card rounded-3xl p-4">
                        <div className="flex gap-2 mb-3">
                            <input className="flex-1 bg-white/70 rounded-xl px-4 py-3 text-sm font-bold focus:outline-blue-500" placeholder={type === 'expenses' ? "È†ÖÁõÆ (Â¶Ç: ÂçàÈ§ê)" : "ÊÉ≥Ë≤∑‰ªÄÈ∫ºÔºü"} value={input.text} onChange={e => setInput({ ...input, text: e.target.value })} />
                            {type === 'expenses' && (
                                <select className="bg-white/70 rounded-xl px-2 py-3 text-sm font-bold focus:outline-blue-500" value={input.payer} onChange={e => setInput({ ...input, payer: e.target.value })}><option value="Â∞èP">Â∞èP‰ªò</option><option value="ÁôæÊ∂µ">ÁôæÊ∂µ‰ªò</option></select>
                            )}
                        </div>
                        {type === 'expenses' && (
                            <div className="flex gap-2 mb-3">
                                <select className="bg-white/70 rounded-xl px-3 py-3 text-sm font-bold focus:outline-blue-500 w-24" value={input.currency} onChange={e => setInput({ ...input, currency: e.target.value })}><option value="JPY">¬• JPY</option><option value="TWD">$ TWD</option></select>
                                <input type="number" className="flex-1 bg-white/70 rounded-xl px-4 py-3 text-sm font-mono font-bold focus:outline-blue-500" placeholder="ÈáëÈ°ç" value={input.amount} onChange={e => setInput({ ...input, amount: e.target.value })} />
                            </div>
                        )}
                        <button onClick={handleAdd} className={`w-full py-3 rounded-xl font-bold text-white flex justify-center items-center gap-2 active:scale-95 transition-transform shadow-lg ${type==='expenses'?'bg-blue-500 shadow-blue-200':'bg-pink-500 shadow-pink-200'}`}><Icon name="Plus" className="w-5 h-5" /> Êñ∞Â¢û</button>
                    </div>

                    <div className="space-y-2">
                        {items.map((item) => (
                            <div key={item.id} className="glass-card p-4 rounded-2xl flex justify-between items-center">
                                {type === 'expenses' ? (
                                    <div className="flex items-center gap-3">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white ${item.payer==='Â∞èP'?'bg-blue-400':'bg-orange-400'}`}>{item.payer[0]}</div>
                                        <div><p className="font-bold text-slate-700">{item.text}</p><p className="text-xs text-slate-400">{new Date(item.createdAt).toLocaleDateString()}</p></div>
                                    </div>
                                ) : (
                                    <div className="flex items-center gap-3">
                                        <button onClick={()=>onItemDelete(item.id, 'toggle')} className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-colors ${item.checked ? 'bg-pink-400 border-pink-400' : 'border-slate-300'}`}>{item.checked && <Icon name="CheckSquare" className="w-4 h-4 text-white"/>}</button>
                                        <span className={`font-bold ${item.checked?'text-slate-400 line-through':'text-slate-700'}`}>{item.text}</span>
                                    </div>
                                )}
                                <div className="flex items-center gap-3">
                                    {type === 'expenses' && <span className={`font-mono font-bold ${item.currency==='JPY'?'text-blue-600':'text-green-600'}`}>{item.currency==='JPY'?'¬•':'$'}{item.amount.toLocaleString()}</span>}
                                    <button onClick={() => onItemDelete(item.id)} className="p-2 text-slate-300 hover:text-red-400 active:bg-red-50 rounded-full"><Icon name="Trash2" className="w-4 h-4" /></button>
                                </div>
                            </div>
                        ))}
                        {items.length === 0 && <div className="text-center py-10 text-slate-400 opacity-50">Êö´ÁÑ°Á¥ÄÈåÑ</div>}
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const { itinerary, expenses, wishlist, user, actions } = useTripData();
            const [activeTab, setActiveTab] = useState('dashboard');
            const [viewMode, setViewMode] = useState('grid');
            const [selectedDay, setSelectedDay] = useState(null);
            const [selectedActivity, setSelectedActivity] = useState(null);

            // ËôïÁêÜÂàÜÂ∏≥ËàáÈ°òÊúõÊ∏ÖÂñÆÁöÑÂà™Èô§ÈÇèËºØ (ÂåÖÂê´È°òÊúõÊ∏ÖÂñÆÁöÑÂãæÈÅ∏)
            const handleItemDelete = (id, actionType = 'delete') => {
                if (activeTab === 'expenses') actions.deleteExpense(id);
                else if (activeTab === 'wishlist') {
                    if (actionType === 'toggle') {
                        const item = wishlist.find(w => w.id === id);
                        if(item) actions.toggleWish(id, !item.checked);
                    } else {
                        actions.deleteWish(id);
                    }
                }
            };

            return (
                <div className="min-h-screen bg-snow-theme">
                    <div className="min-h-screen bg-blue-50/40 backdrop-blur-[1px] pb-safe relative overflow-hidden">
                        {/* Èõ¢Á∑öÊèêÁ§∫ */}
                        {!user && <div className="fixed top-0 left-0 right-0 bg-orange-500 text-white text-xs py-1 text-center z-50">Èõ¢Á∑öÊ®°Âºè - Ë≥áÊñôÂÉÖÊö´Â≠òÊñºÊú¨Âú∞</div>}

                        {/* ‰∏ªË¶ÅÂÖßÂÆπÂçÄ */}
                        <main className="max-w-md mx-auto h-full">
                            {activeTab === 'dashboard' && <DashboardView itinerary={itinerary} />}
                            
                            {activeTab === 'itinerary' && (
                                <>
                                    {viewMode === 'grid' ? (
                                        <CalendarGridView itinerary={itinerary} onSelectDay={(day) => { setSelectedDay(day); setViewMode('detail'); }} />
                                    ) : (
                                        <DayDetailView day={selectedDay} onBack={() => setViewMode('grid')} onSelectActivity={setSelectedActivity} />
                                    )}
                                </>
                            )}

                            {activeTab === 'expenses' && <SharedListView title="ÂàÜÂ∏≥Âä©Êâã" icon="Wallet" items={expenses} onItemAdd={actions.addExpense} onItemDelete={handleItemDelete} type="expenses" />}
                            
                            {activeTab === 'wishlist' && <SharedListView title="È°òÊúõÊ∏ÖÂñÆ" icon="Heart" items={wishlist} onItemAdd={actions.addWish} onItemDelete={handleItemDelete} type="wishlist" />}
                        </main>
                        
                        {/* ÂΩàÂá∫Ë¶ñÁ™ó (Ë°åÁ®ãË©≥Á¥∞) */}
                        <ActivityBottomSheet 
                            activity={selectedActivity}
                            isOpen={!!selectedActivity}
                            onClose={() => setSelectedActivity(null)}
                            onSave={async (newAct) => {
                                const newActs = selectedDay.activities.map(a => a.id === newAct.id ? newAct : a);
                                await actions.updateDayActivities(selectedDay.id, newActs);
                                setSelectedActivity(null);
                            }}
                            onDelete={async (actId) => {
                                const newActs = selectedDay.activities.filter(a => a.id !== actId);
                                await actions.updateDayActivities(selectedDay.id, newActs);
                                setSelectedActivity(null);
                            }}
                        />

                        <BottomNav activeTab={activeTab} onTabChange={(tab) => { setActiveTab(tab); if(tab !== 'itinerary') setViewMode('grid'); }} />
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>